---
title: "Distribution of Cohort Recruitment"
output: html_document
---


## Distribution of Cohort Recruitment

1. Assume the Poisson-Gamma model of recruitment, such that recruitment at each site, $i$, follows a Poisson distribution with rate parameter $\lambda_i$ drawn from a Gamma distribution.


2. Let $I_t$ be the number of sites initialized at time $t$. Assume time required to establish a site, $s_i$, is randomly distributed, and expected time required to establish a site, $E[s_i]$, is a function of the number of sites initialized in the cohort, $f(I_t)$.

3. Assume also that time to establish a site and the rate parameter of recruitment for the site are independent.

4. It was found by derivation that the expected value of recruitment for a cohort would be:

I_0 \frac{\alpha}{\beta} F_s(t) \left[ t - E[s_i] + E[s_i | s_i > t] \right]


5. It was found by derivation that the variance of recruitment for a cohort would be:

I_0 [\mu - \mu^2] 
+ I_0 \frac{\alpha + \alpha^2}{\beta^2} 
  [ t^2 F_s(t) - 2 t E[s_i] + 2 t (1-F_s(t))E[s_i|s_i > t] + E[s_i^2] - (1-F_s(t))E[s_i^2 | s_i > t] ]

where \mu is the expected value of recruitment.


6. Letting establishment time be distributed exponential with rate parameter \lambda_{I_0}:

F_s(t) = 1-e^{-\lambda_{I_0} t}
E[s_i] = 1/\lambda_{I_0}
E[s_i|s_i > t] = 1/\lambda_{I_0} + t
E[s_i^2] = 2/\lambda_{I_0}^2
E[s_i^2 | s_i > t] = 2/\lambda_{I_0}^2 + 2t/\lambda_{I_0} + t^2

7. We then have expected value of recruitment for the cohort:

I_0 \frac{\alpha}{\beta} \left[ t (1-e^{-\lambda_{I_0} t}) - E[s_i] + (e^{-\lambda_{I_0} t})(1/\lambda_{I_0} + t) \right]


8. We then have variance of recruitment for the cohort:

I_0 [\mu - \mu^2] 
+ I_0 \frac{\alpha + \alpha^2}{\beta^2} 
  [ t^2 (1-e^{-\lambda_{I_0} t}) 
    - 2 t (1/\lambda_{I_0}) 
    + 2 t (e^{-\lambda_{I_0} t})(1/\lambda_{I_0} + t) 
    + (2/\lambda_{I_0}^2) 
    - (e^{-\lambda_{I_0} t})(2/\lambda_{I_0}^2 + 2t/\lambda_{I_0} + t^2) ]

```{r import libraries, include=TRUE}

library(ggplot2)
library(scales)

```


```{r expected value function, include=TRUE}

expected_recruitment_cohort <- function(I_0, alpha, beta, lambda_I_0, t){
  
  expected_recruitment <- I_0 * alpha / beta * t * (1-exp(-lambda_I_0 * t)) -
                          I_0 * alpha / beta * (1 / lambda_I_0) + 
                          I_0 * alpha / beta * exp(-lambda_I_0 * t) * (1/lambda_I_0 + t)

  return(expected_recruitment)
  
}

```


```{r variance function, include=TRUE}

variance_recruitment_cohort <- function(I_0, alpha, beta, lambda_I_0, t){
  
  
  mu <- expected_recruitment_cohort(I_0=I_0, alpha=alpha, 
                                     beta=beta, lambda_I_0=lambda_I_0,
                                     t=t) / I_0

  
  
  variance_recruitment <-I_0 * (mu - mu^2) + 
                          I_0 * (alpha + alpha^2) / (beta^2) * 
                        ( t^2 * (1-exp(-lambda_I_0 * t))
                          - 2 * t * (1 / lambda_I_0)
                          + 2 * t * exp(-lambda_I_0 * t) * (1/lambda_I_0 + t)
                          + (2/lambda_I_0^2) 
                          - exp(-lambda_I_0 * t) * (2/lambda_I_0^2 + 2*t/lambda_I_0 + t^2) )
  
  
  return(variance_recruitment)
  
}

```


```{r simulation function, include=True}

simulate_cohort_return <- function(I_0, alpha, beta, lambda_I_0, t, n_sims){
  
  establishment_times <- rexp(n=I_0 * n_sims, rate=lambda_I_0)
  
  recruitment_rates <- rgamma(n=I_0 * n_sims, shape=alpha, rate=beta)
  
  recruitment_period_lengths <- t - establishment_times
  
  recruitment_period_lengths[recruitment_period_lengths < 0] = 0
  
  site_recruitment <- rpois(n=I_0 * n_sims, lambda = recruitment_period_lengths * recruitment_rates)
  
  site_recruitment_by_cohort <- split(site_recruitment, rep(c(1:n_sims),I_0))
  
  total_recruitment_by_cohort <- unlist(lapply(site_recruitment_by_cohort, function(x) sum(x)))
  
  return(total_recruitment_by_cohort)
  
}

```



```{r perform_simulation, include=True}

expected_recruitment_by_cohort_1 <- expected_recruitment_cohort(I_0 = 100, alpha = 2, beta = 2/5
                                                                , lambda_I_0 = 1/30, t = 240)


variance_recruitment_by_cohort_1 <- variance_recruitment_cohort(I_0 = 100, alpha = 2, beta = 2/5
                                                                , lambda_I_0 = 1/30, t = 240)


total_recruitment_by_cohort_1 <- simulate_cohort_return(I_0 = 100, alpha = 2, beta = 2/5
                                                        , lambda_I_0 = 1/30, t = 240, n_sim=1000)

mean_recruitment_by_cohort_1 <- mean(total_recruitment_by_cohort_1)

obs_var_recruitment_by_cohort_1 <- var(total_recruitment_by_cohort_1)



total_recruitment_by_cohort_2 <- simulate_cohort_return(I_0 = 100, alpha = 2, beta = 2/5
                                                        , lambda_I_0 = 1/30, t = 240, n_sim=1000)

mean_recruitment_by_cohort_2 <- mean(total_recruitment_by_cohort_2)

obs_var_recruitment_by_cohort_2 <- var(total_recruitment_by_cohort_2)


total_recruitment_by_cohort_3 <- simulate_cohort_return(I_0 = 100, alpha = 2, beta = 2/5
                                                        , lambda_I_0 = 1/30, t = 240, n_sim=1000)

mean_recruitment_by_cohort_3 <- mean(total_recruitment_by_cohort_3)

obs_var_recruitment_by_cohort_3 <- var(total_recruitment_by_cohort_3)

```




```{r perform_simulation_mult_params, include=True}

results_df <- data.frame()

result_cols <- c("Sites in Cohort"
                 ,"Alpha"
                 ,"Beta"
                 ,"Mean Establishment Time Days"
                 ,"Trial Length Days"
                 ,"Expected Recruitment"
                 ,"Simulation 1 Mean","Simulation 2 Mean","Simulation 3 Mean"
                 ,"Standard Deviation of Recruitment"
                 ,"Simulation 1 Standard Deviation"
                 ,"Simulation 2 Standard Deviation","Simulation 3 Standard Deviation"
                 ,"Simulations Performed")


I_0_levels <- c(50, 100)
alpha_levels <- c(2,4)
beta_levels <- c(1/5, 2/5)
lambda_I_0_levels <- c(1/30, 1/60)
t_levels <- c(120, 240)
n_sims_level <- 10000

for (I_0_level in I_0_levels){
  
  for (alpha_level in alpha_levels){
    
    for(beta_level in beta_levels){
      
      for(lambda_I_0_level in lambda_I_0_levels){
        
        for (t_level in t_levels){
          
          
          simulation_1_totals <- simulate_cohort_return(I_0 = I_0_level, alpha = alpha_level,
                                                          beta = beta_level, lambda_I_0 = lambda_I_0_level,
                                                          t = t_level, n_sims = n_sims_level)
          
          simulation_2_totals <- simulate_cohort_return(I_0 = I_0_level, alpha = alpha_level,
                                                          beta = beta_level, lambda_I_0 = lambda_I_0_level,
                                                          t = t_level, n_sims = n_sims_level)
            
          simulation_3_totals <- simulate_cohort_return(I_0 = I_0_level, alpha = alpha_level,
                                                          beta = beta_level, lambda_I_0 = lambda_I_0_level,
                                                          t = t_level, n_sims = n_sims_level)
          
          results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
          colnames(results_newline) <- result_cols
    
        
          results_newline[["Sites in Cohort"]] <- I_0_level
          results_newline[["Alpha"]] <- alpha_level
          results_newline[["Beta"]] <- beta_level
          results_newline[["Mean Establishment Time Days"]] <- 1 / lambda_I_0_level
          results_newline[["Trial Length Days"]] <- t_level
          
          results_newline[["Expected Recruitment"]] <- expected_recruitment_cohort(
                                                          I_0 = I_0_level, alpha = alpha_level,
                                                          beta = beta_level, lambda_I_0 = lambda_I_0_level,
                                                          t = t_level)
          results_newline[["Standard Deviation of Recruitment"]] <- sqrt(variance_recruitment_cohort(
                                                            I_0 = I_0_level, alpha = alpha_level,
                                                            beta = beta_level, lambda_I_0 = lambda_I_0_level,
                                                            t = t_level))
          
          results_newline[["Simulation 1 Mean"]] <- mean(simulation_1_totals)
          results_newline[["Simulation 2 Mean"]] <- mean(simulation_2_totals)
          results_newline[["Simulation 3 Mean"]] <- mean(simulation_3_totals)
          
          results_newline[["Simulation 1 Standard Deviation"]] <- sqrt(var(simulation_1_totals))
          results_newline[["Simulation 2 Standard Deviation"]] <- sqrt(var(simulation_2_totals))
          results_newline[["Simulation 3 Standard Deviation"]] <- sqrt(var(simulation_3_totals))
          
          results_newline[["Simulations Performed"]] <- n_sims_level
          
          results_df <- rbind(results_df,results_newline)
          
          
        }
      }
    }
  }
}

write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_reruitment_study_3.csv",row.names=FALSE)

```



```{r expected establishment vs cohort size, include=True}

#testing that lambda_I_0 is set as intended
#should have mean establishment time increase 1 week for every 5 sites

I_0_levels <- c(1:100) * 5

n_sims_level <- 100000

results_df <- data.frame()
result_cols <- c("Sites in Cohort","Sets of 5 Sites in Cohort","Mean Establishment Time in Weeks")

for(I_0_level in I_0_levels){
  
  lambda_I_0_level <- 5 / 7 / I_0_level
  
  establishment_times <- rexp(n=n_sims_level, rate=lambda_I_0_level)
  
  mean_establishment_time <- mean(establishment_times)
  
  results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
  colnames(results_newline) <- result_cols
  
  results_newline[["Sites in Cohort"]] <- I_0_level
  results_newline[["Sets of 5 Sites in Cohort"]] <- I_0_level / 5
  results_newline[["Mean Establishment Time in Weeks"]] <- mean_establishment_time / 7
  
  results_df <- rbind(results_df,results_newline)
  
}



```


```{r expected recruitment vs cohort size, include=True}

I_0_levels <- c(1:100) * 5

results_df <- data.frame()
result_cols <- c("Length_of_Trial_in_Weeks","Sites_in_Cohort",
                 "Sets_of_5_Sites_in_Cohort","Mean_Establishment_Time_in_Weeks",
                 "Expected_Recruitment","Standard_Deviation_of_Recruitment",
                 "Mean_Simulated_Recruitment","Standard_Deviation_of_Simulated_Recruitment")

t_levels <- c(1:10) * 14

alpha_level <- 1
beta_level <- 1

n_sims_level <- 100

for(t_level in t_levels){
  
  for(I_0_level in I_0_levels){
    
    lambda_I_0_level <- 5 / 7 / I_0_level
    
    expected_recruitment <- expected_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)
    
    variance_recruitment <- variance_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)
    
    simulated_recruitment <- simulate_cohort_return(I_0 = I_0_level, alpha = alpha_level,
                                                      beta = beta_level, lambda_I_0 = lambda_I_0_level,
                                                      t = t_level, n_sims = n_sims_level)
    
    results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
    colnames(results_newline) <- result_cols
    
    results_newline[["Length_of_Trial_in_Weeks"]] <- t_level / 7
    results_newline[["Sites_in_Cohort"]] <- I_0_level
    results_newline[["Sets_of_5_Sites_in_Cohort"]] <- I_0_level / 5
    results_newline[["Mean_Establishment_Time_in_Weeks"]] <- 1 / lambda_I_0_level
    results_newline[["Expected_Recruitment"]] <- expected_recruitment
    results_newline[["Standard_Deviation_of_Recruitment"]] <- sqrt(variance_recruitment)
    results_newline[["Lower_Bound_of_Recruitment"]] <- expected_recruitment - 2 * sqrt(variance_recruitment)
    results_newline[["Upper_Bound_of_Recruitment"]] <- expected_recruitment + 2 * sqrt(variance_recruitment)
    results_newline[["Mean_Simulated_Recruitment"]] <- mean(simulated_recruitment)
    results_newline[["Standard_Deviation_of_Simulated_Recruitment"]] <- sqrt(var(simulated_recruitment))
    
    
    results_df <- rbind(results_df,results_newline)
    
  }
  
}


write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_reruitment_study_4.csv",row.names=FALSE)


```

```{r plot expected recruitment vs cohort size, include=True}

ggplot() +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Expected_Recruitment, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Lower_Bound_of_Recruitment, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Upper_Bound_of_Recruitment, group=1)) +
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Sites in Cohort") +
  ylab("Expected Recruitment with 95% Confidence Bounds") + 
  ggtitle("Total Recruitment per Cohort Size by Trial Length in Weeks")


ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_4.png")


```

```{r plot expected recruitment vs cohort size, include=True}

ggplot() +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Expected_Recruitment, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Mean_Simulated_Recruitment, group=1)) +
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Sites in Cohort") +
  ylab("Expected Recruitment") + 
  ggtitle("Total Recruitment per Cohort Size by Trial Length in Weeks - Expected and Simulated")


ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_4b.png")


```


```{r expected recruitment vs cohort size, include=True}

I_0_levels <- c(1:100) * 500

results_df <- data.frame()

result_cols <- c("Length_of_Trial_in_Weeks","Sites_in_Cohort",
                 "Sets_of_5_Sites_in_Cohort","Mean_Establishment_Time_in_Weeks",
                 "Expected_Recruitment","Standard_Deviation_of_Recruitment",
                 "Lower_Bound_of_Recruitment","Upper_Bound_of_Recruitment")

t_levels <- c(1:10) * 14

alpha_level <- 1
beta_level <- 1

n_sims_level <- 100

for(t_level in t_levels){
  
  for(I_0_level in I_0_levels){
    
    lambda_I_0_level <- 5 / 7 / I_0_level
    
    expected_recruitment <- expected_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)
    
    variance_recruitment <- variance_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)
    
    
    results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
    colnames(results_newline) <- result_cols
    
    results_newline[["Length_of_Trial_in_Weeks"]] <- t_level / 7
    results_newline[["Sites_in_Cohort"]] <- I_0_level
    results_newline[["Sets_of_5_Sites_in_Cohort"]] <- I_0_level / 5
    results_newline[["Mean_Establishment_Time_in_Weeks"]] <- 1 / lambda_I_0_level
    results_newline[["Expected_Recruitment"]] <- expected_recruitment
    results_newline[["Standard_Deviation_of_Recruitment"]] <- sqrt(variance_recruitment)
    results_newline[["Lower_Bound_of_Recruitment"]] <- expected_recruitment - 2 * sqrt(variance_recruitment)
    results_newline[["Upper_Bound_of_Recruitment"]] <- expected_recruitment + 2 * sqrt(variance_recruitment)
    
    results_df <- rbind(results_df,results_newline)
    
  }
  
}


write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_reruitment_study_5.csv",row.names=FALSE)


```


```{r plot expected recruitment vs cohort size, include=True}

ggplot() +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Expected_Recruitment, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Lower_Bound_of_Recruitment, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Upper_Bound_of_Recruitment, group=1)) +
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Sites in Cohort") +
  ylab("Expected Recruitment with 95% Confidence Bounds") + 
  ggtitle("Total Recruitment per Cohort Size by Trial Length in Weeks")


ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_5.png")


```



```{r simulate with nonlinear increase in activation time, include=True}

I_0_levels <- c(1:100) * 500

results_df <- data.frame()

result_cols <- c("Length_of_Trial_in_Weeks","Sites_in_Cohort",
                 "Sets_of_5_Sites_in_Cohort","Mean_Establishment_Time_in_Weeks",
                 "Expected_Recruitment","Standard_Deviation_of_Recruitment",
                 "Lower_Bound_of_Recruitment","Upper_Bound_of_Recruitment")

t_levels <- c(1:10) * 14

alpha_level <- 1
beta_level <- 1

n_sims_level <- 100

for(t_level in t_levels){
  
  for(I_0_level in I_0_levels){
    
    lambda_I_0_level <- 5 / 7 / (I_0_level^1.2)
    
    expected_recruitment <- expected_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)
    
    variance_recruitment <- variance_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)
    
    
    results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
    colnames(results_newline) <- result_cols
    
    results_newline[["Length_of_Trial_in_Weeks"]] <- t_level / 7
    results_newline[["Sites_in_Cohort"]] <- I_0_level
    results_newline[["Sets_of_5_Sites_in_Cohort"]] <- I_0_level / 5
    results_newline[["Mean_Establishment_Time_in_Weeks"]] <- 1 / lambda_I_0_level
    results_newline[["Expected_Recruitment"]] <- expected_recruitment
    results_newline[["Standard_Deviation_of_Recruitment"]] <- sqrt(variance_recruitment)
    results_newline[["Lower_Bound_of_Recruitment"]] <- expected_recruitment - 2 * sqrt(variance_recruitment)
    results_newline[["Upper_Bound_of_Recruitment"]] <- expected_recruitment + 2 * sqrt(variance_recruitment)
    
    results_df <- rbind(results_df,results_newline)
    
  }
  
}


write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_reruitment_study_6.csv",row.names=FALSE)


```


```{r plot expected recruitment vs cohort size, include=True}

ggplot() +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Expected_Recruitment, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Lower_Bound_of_Recruitment, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Upper_Bound_of_Recruitment, group=1)) +
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Sites in Cohort") +
  ylab("Expected Recruitment with 95% Confidence Bounds") + 
  ggtitle("Total Recruitment per Cohort Size by Trial Length in Weeks")


ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_6.png")


```


```{r simulate with nonlinear increase in activation time, include=True}

I_0_levels <- c(1:100) * 500

results_df <- data.frame()

result_cols <- c("Length_of_Trial_in_Weeks","Sites_in_Cohort",
                 "Sets_of_5_Sites_in_Cohort","Mean_Establishment_Time_in_Weeks",
                 "Expected_Recruitment","Standard_Deviation_of_Recruitment",
                 "Lower_Bound_of_Recruitment","Upper_Bound_of_Recruitment")

t_levels <- c(1:10) * 14

alpha_level <- 1
beta_level <- 1

n_sims_level <- 100

for(t_level in t_levels){
  
  for(I_0_level in I_0_levels){
    
    lambda_I_0_level <- 5 / 7 / (I_0_level^.8)
    
    expected_recruitment <- expected_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)
    
    variance_recruitment <- variance_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)
    
    
    results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
    colnames(results_newline) <- result_cols
    
    results_newline[["Length_of_Trial_in_Weeks"]] <- t_level / 7
    results_newline[["Sites_in_Cohort"]] <- I_0_level
    results_newline[["Sets_of_5_Sites_in_Cohort"]] <- I_0_level / 5
    results_newline[["Mean_Establishment_Time_in_Weeks"]] <- 1 / lambda_I_0_level
    results_newline[["Expected_Recruitment"]] <- expected_recruitment
    results_newline[["Standard_Deviation_of_Recruitment"]] <- sqrt(variance_recruitment)
    results_newline[["Lower_Bound_of_Recruitment"]] <- expected_recruitment - 2 * sqrt(variance_recruitment)
    results_newline[["Upper_Bound_of_Recruitment"]] <- expected_recruitment + 2 * sqrt(variance_recruitment)
    
    results_df <- rbind(results_df,results_newline)
    
  }
  
}


write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_reruitment_study_7.csv",row.names=FALSE)


```


```{r plot expected recruitment vs cohort size, include=True}

ggplot() +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Expected_Recruitment, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Lower_Bound_of_Recruitment, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Upper_Bound_of_Recruitment, group=1)) +
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Sites in Cohort") +
  ylab("Expected Recruitment with 95% Confidence Bounds") + 
  ggtitle("Total Recruitment per Cohort Size by Trial Length in Weeks")


ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_7.png")


```


```{r get anticipated recruitment with and without accounting for random initialization, include=True}

poisson_gamma_expected_value <- function(I_0, alpha, beta, t){
  
  return( (alpha * I_0 * t) / (beta) )
  
}

poisson_gamma_variance <- function(I_0, alpha, beta, t){
  
  return( ( (alpha * I_0 * t) / beta) + ( (alpha * I_0 * t^2) / beta^2) )
  
}


simulate_poisson_gamma_return <- function(I_0, alpha, beta, t, n_sims){
  
  establishment_times <- 0
  
  recruitment_rates <- rgamma(n=I_0 * n_sims, shape=alpha, rate=beta)
  
  recruitment_period_lengths <- t - establishment_times
  
  recruitment_period_lengths[recruitment_period_lengths < 0] = 0
  
  site_recruitment <- rpois(n=I_0 * n_sims, lambda = recruitment_period_lengths * recruitment_rates)
  
  site_recruitment_by_cohort <- split(site_recruitment, rep(c(1:n_sims),I_0))
  
  total_recruitment_by_cohort <- unlist(lapply(site_recruitment_by_cohort, function(x) sum(x)))
  
  return(total_recruitment_by_cohort)
  
}


```



```{r test poisson-gamma formula against simulation, include=True}


results_df <- data.frame()

result_cols <- c("Sites in Cohort"
                 ,"Alpha"
                 ,"Beta"
                 ,"Mean Establishment Time Days"
                 ,"Trial Length Days"
                 ,"Expected Recruitment"
                 ,"Simulation 1 Mean","Simulation 2 Mean","Simulation 3 Mean"
                 ,"Standard Deviation of Recruitment"
                 ,"Simulation 1 Standard Deviation"
                 ,"Simulation 2 Standard Deviation","Simulation 3 Standard Deviation"
                 ,"Simulations Performed")


I_0_levels <- c(50, 100)
alpha_levels <- c(2,4)
beta_levels <- c(1/5, 2/5)
lambda_I_0_levels <- c(1/30, 1/60)
t_levels <- c(120, 240)
n_sims_level <- 100000

for (I_0_level in I_0_levels){
  
  for (alpha_level in alpha_levels){
    
    for(beta_level in beta_levels){
      
      for(lambda_I_0_level in lambda_I_0_levels){
        
        for (t_level in t_levels){
          
          
          simulation_1_totals <- simulate_poisson_gamma_return(I_0 = I_0_level, alpha = alpha_level,
                                                          beta = beta_level, 
                                                          t = t_level, n_sims = n_sims_level)
          
          simulation_2_totals <- simulate_poisson_gamma_return(I_0 = I_0_level, alpha = alpha_level,
                                                          beta = beta_level, 
                                                          t = t_level, n_sims = n_sims_level)
            
          simulation_3_totals <- simulate_poisson_gamma_return(I_0 = I_0_level, alpha = alpha_level,
                                                          beta = beta_level, 
                                                          t = t_level, n_sims = n_sims_level)
          
          results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
          colnames(results_newline) <- result_cols
    
        
          results_newline[["Sites in Cohort"]] <- I_0_level
          results_newline[["Alpha"]] <- alpha_level
          results_newline[["Beta"]] <- beta_level
          results_newline[["Mean Establishment Time Days"]] <- 1 / lambda_I_0_level
          results_newline[["Trial Length Days"]] <- t_level
          
          results_newline[["Expected Recruitment"]] <- poisson_gamma_expected_value(
                                                          I_0 = I_0_level, alpha = alpha_level,
                                                          beta = beta_level, t = t_level)
          results_newline[["Standard Deviation of Recruitment"]] <- sqrt(poisson_gamma_variance(
                                                            I_0 = I_0_level, alpha = alpha_level,
                                                            beta = beta_level, t = t_level))
          
          results_newline[["Simulation 1 Mean"]] <- mean(simulation_1_totals)
          results_newline[["Simulation 2 Mean"]] <- mean(simulation_2_totals)
          results_newline[["Simulation 3 Mean"]] <- mean(simulation_3_totals)
          
          results_newline[["Simulation 1 Standard Deviation"]] <- sqrt(var(simulation_1_totals))
          results_newline[["Simulation 2 Standard Deviation"]] <- sqrt(var(simulation_2_totals))
          results_newline[["Simulation 3 Standard Deviation"]] <- sqrt(var(simulation_3_totals))
          
          results_newline[["Simulations Performed"]] <- n_sims_level
          
          results_df <- rbind(results_df,results_newline)
          
          
        }
      }
    }
  }
}


write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/test poisson gamma.csv",row.names=FALSE)


```



```{r simulate with nonlinear increase in activation time, include=True}

I_0_levels <- c(1:100) * 2

results_df <- data.frame()

result_cols <- c("Length_of_Trial_in_Weeks","Sites_in_Cohort",
                 "Sets_of_5_Sites_in_Cohort","Mean_Establishment_Time_in_Weeks",
                 
                 "Expected_Recruitment_RE","Standard_Deviation_of_Recruitment_RE",
                 "Lower_Bound_of_Recruitment_RE","Upper_Bound_of_Recruitment_RE",
                 
                 "Expected_Recruitment_N1","Standard_Deviation_of_Recruitment_N1",
                 "Lower_Bound_of_Recruitment_N1","Upper_Bound_of_Recruitment_N1",
                 
                 "Expected_Recruitment_N2","Standard_Deviation_of_Recruitment_N2",
                 "Lower_Bound_of_Recruitment_N2","Upper_Bound_of_Recruitment_N2")

t_levels <- c(1:10) * 14

alpha_level <- 1
beta_level <- 1

lambda_I_0_naive <- 5 / 7 / (20)

for(t_level in t_levels){
  
  for(I_0_level in I_0_levels){
    
    lambda_I_0_level <- 5 / 7 / (I_0_level)
    
    
    
    expected_recruitment_re <- expected_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)
    
    variance_recruitment_re <- variance_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_level,
                                                      t=t_level)

    
    
    expected_recruitment_n1 <- poisson_gamma_expected_value(I_0=I_0_level, alpha=alpha_level,
                                                            beta=beta_level, t=t_level)
    
    variance_recruitment_n1 <- poisson_gamma_variance(I_0=I_0_level, alpha=alpha_level,
                                                      beta=beta_level, t=t_level)
    
    
    
    
    expected_recruitment_n2 <- expected_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_naive,
                                                      t=t_level)
    
    variance_recruitment_n2 <- variance_recruitment_cohort(I_0=I_0_level,alpha=alpha_level,beta=beta_level,
                                                      lambda_I_0 = lambda_I_0_naive,
                                                      t=t_level)
    
    
    
    results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
    colnames(results_newline) <- result_cols
    
    results_newline[["Length_of_Trial_in_Weeks"]] <- t_level / 7
    results_newline[["Sites_in_Cohort"]] <- I_0_level
    results_newline[["Sets_of_5_Sites_in_Cohort"]] <- I_0_level / 5
    results_newline[["Mean_Establishment_Time_in_Weeks"]] <- 1 / lambda_I_0_level
    
    results_newline[["Expected_Recruitment_RE"]] <- expected_recruitment_re
    results_newline[["Standard_Deviation_of_Recruitment_RE"]] <- sqrt(variance_recruitment_re)
    results_newline[["Lower_Bound_of_Recruitment_RE"]] <- expected_recruitment_re - 
                                                            2 * sqrt(variance_recruitment_re)
    results_newline[["Upper_Bound_of_Recruitment_RE"]] <- expected_recruitment_re + 
                                                            2 * sqrt(variance_recruitment_re)
    
    results_newline[["Expected_Recruitment_N1"]] <- expected_recruitment_n1
    results_newline[["Standard_Deviation_of_Recruitment_N1"]] <- sqrt(variance_recruitment_n1)
    results_newline[["Lower_Bound_of_Recruitment_N1"]] <- expected_recruitment_n1 - 
                                                            2 * sqrt(variance_recruitment_n1)
    results_newline[["Upper_Bound_of_Recruitment_N1"]] <- expected_recruitment_n1 + 
                                                            2 * sqrt(variance_recruitment_n1)
    
    results_newline[["Expected_Recruitment_N2"]] <- expected_recruitment_n2
    results_newline[["Standard_Deviation_of_Recruitment_N2"]] <- sqrt(variance_recruitment_n2)
    results_newline[["Lower_Bound_of_Recruitment_N2"]] <- expected_recruitment_n2 - 
                                                            2 * sqrt(variance_recruitment_n2)
    results_newline[["Upper_Bound_of_Recruitment_N2"]] <- expected_recruitment_n2 + 
                                                            2 * sqrt(variance_recruitment_n2)
    
    results_df <- rbind(results_df,results_newline)
    
  }
  
}


write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_reruitment_study_8.csv",row.names=FALSE)


```


```{r plot expected recruitment vs cohort size, include=True}

ggplot() +

  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Expected_Recruitment_RE, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Lower_Bound_of_Recruitment_RE, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Upper_Bound_of_Recruitment_RE, group=1)) +
  
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Sites in Cohort") +
  ylab("Expected Recruitment with 95% Confidence Bounds") + 
  ggtitle("Total Recruitment per Cohort Size by Trial Length in Weeks")


ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_8_re.png")

```


```{r plot expected recruitment vs cohort size, include=True}

ggplot() +

  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Expected_Recruitment_N1, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Lower_Bound_of_Recruitment_N1, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Upper_Bound_of_Recruitment_N1, group=1)) +
  
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Sites in Cohort") +
  ylab("Expected Recruitment with 95% Confidence Bounds") + 
  ggtitle("Total Recruitment per Cohort Size by Trial Length in Weeks")

ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_8_n1.png")

```


```{r plot expected recruitment vs cohort size, include=True}

ggplot() +

  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Expected_Recruitment_N2, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Lower_Bound_of_Recruitment_N2, group=1)) +
  geom_line(data=results_df, aes(x=Sites_in_Cohort,y=Upper_Bound_of_Recruitment_N2, group=1)) +
  
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Sites in Cohort") +
  ylab("Expected Recruitment with 95% Confidence Bounds") + 
  ggtitle("Total Recruitment per Cohort Size by Trial Length in Weeks")

ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_8_n2.png")

```





```{r get the smallest sized cohort to meet N recruits by time t, include=True}

get_needed_cohort_size <- function(N, t, alpha, beta, rho, confidence, I_limit){

I_0_level <- 0
needed_size_found <- FALSE
phi_confidence <- qnorm(1-confidence)

while ( (I_0_level < I_limit) & (needed_size_found == FALSE)){

  I_0_level <- I_0_level + 1
  lambda_I_0 <- rho / I_0_level

  
  expected_recruitment <- expected_recruitment_cohort(I_0=I_0_level,alpha=alpha,beta=beta,
                                                      lambda_I_0 = lambda_I_0,
                                                      t=t)
    
  variance_recruitment <- variance_recruitment_cohort(I_0=I_0_level,alpha=alpha,beta=beta,
                                                      lambda_I_0 = lambda_I_0,
                                                      t=t)
                                                      
  lower_bound_recruitment <- expected_recruitment + phi_confidence * sqrt(variance_recruitment)
  
  if (lower_bound_recruitment > N) {
    needed_size_found = TRUE}
  
}

if(I_0_level < I_limit){
  return(I_0_level) }
else{
  return(NULL) }  
  
  
}

```


```{r test get_needed_cohort_size}

needed_size <- get_needed_cohort_size(N=3700, t = 140, alpha=1, beta=1, rho=5/7, confidence = 0.95, I_limit=1000)

needed_size


```


```{r needed recruitment vs needed cohort size, include=True}


results_df <- data.frame()
result_cols <- c("Length_of_Trial_in_Weeks","Needed_Recruitment",
                 "Needed_Cohort_Size")

t_levels <- c(1:10) * 14
N_levels <- c(1:100) * 50

alpha_level <- 1
beta_level <- 1

for(t_level in t_levels){
  
  for(N_level in N_levels){
    
    
    needed_size <- get_needed_cohort_size(N=N_level, t = t_level, alpha=1, beta=1, rho=5/7,
                                          confidence = 0.95, I_limit=1000)
    
    results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
    colnames(results_newline) <- result_cols
    
    results_newline[["Length_of_Trial_in_Weeks"]] <- t_level / 7
    results_newline[["Needed_Recruitment"]] <- N_level
    if (! is.null(needed_size)){
      results_newline[["Needed_Cohort_Size"]] <- needed_size
    }
    else {
      results_newline[["Needed_Cohort_Size"]] <- 0
    }
    

    
    results_df <- rbind(results_df,results_newline)
    
  }
  
}


write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_reruitment_study_9.csv",row.names=FALSE)


```

```{r plot expected recruitment vs cohort size, include=True}

ggplot() +
  geom_line(data=results_df, aes(x=Needed_Recruitment,y=Needed_Cohort_Size, group=1)) +
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Required Recruitment") +
  ylab("Required Cohort Size with 95% Confidence") + 
  ggtitle("Required Cohort Size for a Given Required Recruitment and Trial Length in Weeks")


ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_9.png")


```



```{r get the smallest sized cohort to meet N recruits by time t with naive models, include=True}

get_needed_cohort_size_n1 <- function(N, t, alpha, beta, confidence, I_limit){

I_0_level <- 0
needed_size_found <- FALSE
phi_confidence <- qnorm(1-confidence)

while ( (I_0_level < I_limit) & (needed_size_found == FALSE)){

  I_0_level <- I_0_level + 1
  
  expected_recruitment <- poisson_gamma_expected_value(I_0=I_0_level,alpha=alpha, beta=beta, t=t)
    
  variance_recruitment <- poisson_gamma_variance(I_0=I_0_level,alpha=alpha,beta=beta, t=t)
                                                      
  lower_bound_recruitment <- expected_recruitment + phi_confidence * sqrt(variance_recruitment)
  
  if (lower_bound_recruitment > N) {
    needed_size_found = TRUE}
  
}

if(I_0_level < I_limit){
  return(I_0_level) }
else{
  return(NULL) }  
  
  
}



get_needed_cohort_size_n2 <- function(N, t, alpha, beta, lambda_I_0_naive, confidence, I_limit){

I_0_level <- 0
needed_size_found <- FALSE
phi_confidence <- qnorm(1-confidence)


while ( (I_0_level < I_limit) & (needed_size_found == FALSE)){

  I_0_level <- I_0_level + 1
  
  expected_recruitment <- expected_recruitment_cohort(I_0=I_0_level,alpha=alpha,beta=beta,
                                                      lambda_I_0 = lambda_I_0_naive,
                                                      t=t)
    
  variance_recruitment <- variance_recruitment_cohort(I_0=I_0_level,alpha=alpha,beta=beta,
                                                      lambda_I_0 = lambda_I_0_naive,
                                                      t=t)
                                                      
  lower_bound_recruitment <- expected_recruitment + phi_confidence * sqrt(variance_recruitment)
  
  if (lower_bound_recruitment > N) {
    needed_size_found = TRUE}
  
}

if(I_0_level < I_limit){
  return(I_0_level) }
else{
  return(NULL) }  
  
  
}

```


```{r test get_needed_cohort_size}

needed_size_re <- get_needed_cohort_size(N=3700, t = 140, alpha=1, beta=1, rho=5/7, confidence = 0.95, I_limit=1000)


needed_size_n1 <- get_needed_cohort_size_n1(N=3700, t=140, alpha=1, beta=1, confidence=0.95, I_limit=1000)

needed_size_n2 <- get_needed_cohort_size_n2(N=3700, t=140, alpha=1, beta=1, lambda=5/7/20, confidence=0.95,
                                            I_limit=1000)

needed_size_re

needed_size_n1

needed_size_n2

```




```{r needed recruitment vs needed cohort size with naive, include=True}


results_df <- data.frame()
result_cols <- c("Length_of_Trial_in_Weeks","Needed_Recruitment",
                 "Model","Needed_Cohort_Size")

t_levels <- c(1:10) * 14
N_levels <- c(1:100) * 50

alpha_level <- 100
beta_level <- 10

for(t_level in t_levels){
  
  for(N_level in N_levels){
    
    
    needed_size_re <- get_needed_cohort_size(N=N_level, t = t_level, alpha=1, beta=1, rho=5/7,
                                          confidence = 0.95, I_limit=1000)
    
    needed_size_n1 <- get_needed_cohort_size_n1(N=N_level, t = t_level, alpha=1, beta=1,
                                          confidence = 0.95, I_limit=1000)
    
    needed_size_n2 <- get_needed_cohort_size_n2(N=N_level, t = t_level, alpha=1, beta=1,
                                                lambda_I_0_naive=5/7/20, confidence = 0.95,
                                                I_limit=1000)
    
    
    
    results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
    colnames(results_newline) <- result_cols
    
    results_newline[["Length_of_Trial_in_Weeks"]] <- t_level / 7
    results_newline[["Needed_Recruitment"]] <- N_level
    results_newline[["Model"]] <- "Random Establishment"
    
    if (! is.null(needed_size_re)){
      results_newline[["Needed_Cohort_Size"]] <- needed_size_re
    }
    else {
      results_newline[["Needed_Cohort_Size"]] <- 0
    }
    
    results_df <- rbind(results_df,results_newline)
    
    
    
    
    results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
    colnames(results_newline) <- result_cols
    
    results_newline[["Length_of_Trial_in_Weeks"]] <- t_level / 7
    results_newline[["Needed_Recruitment"]] <- N_level
    results_newline[["Model"]] <- "Naive 1"
    
    if (! is.null(needed_size_n1)){
      results_newline[["Needed_Cohort_Size"]] <- needed_size_n1
    }
    else {
      results_newline[["Needed_Cohort_Size"]] <- 0
    }
    
    results_df <- rbind(results_df,results_newline)
    
    
    results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
    colnames(results_newline) <- result_cols
    
    results_newline[["Length_of_Trial_in_Weeks"]] <- t_level / 7
    results_newline[["Needed_Recruitment"]] <- N_level
    results_newline[["Model"]] <- "Naive 2"
    
    if (! is.null(needed_size_n2)){
      results_newline[["Needed_Cohort_Size"]] <- needed_size_n2
    }
    else {
      results_newline[["Needed_Cohort_Size"]] <- 0
    }
    
    results_df <- rbind(results_df,results_newline)
    
    
  }
  
}


write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_reruitment_study_10.csv",row.names=FALSE)


```


```{r plot expected recruitment vs cohort size with naive, include=True}

ggplot() +
  geom_line(data=results_df, aes(x=Needed_Recruitment,y=Needed_Cohort_Size, group=Model, color=Model)) +
  facet_grid(Length_of_Trial_in_Weeks ~ .) +
  xlab("Required Recruitment") +
  ylab("Required Cohort Size with 95% Confidence") + 
  ggtitle("Required Cohort Size for a Given Required Recruitment and Trial Length in Weeks")


ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_10.png")


```



Now, assume there is some cost to the delay of the study, and some cost to the startup of additional sites. Let T_d be the trial deadline, let c1 be the cost per site, and let c2 be the cost per day past the trial deadline.

```{r function to simulate recruitment and get delay costs}

simulate_cost_by_site_activation <- function(N, I, lambda_I, alpha, beta, n_sims=1){
    
  activation_times <- rexp(n = I * n_sims, rate=lambda_I)
  recruitment_rates <- rgamma(n = I * n_sims, shape=alpha, rate=beta)
  recruited <- data.frame(matrix(unlist(rep(0,I*n_sims)), ncol=n_sims, byrow=FALSE))
  recruit_sums <- colSums(recruited)
  
  completed <- recruit_sums >= N
  completed_prev <- rep(FALSE, n_sims)
  day_completed <- rep(0,n_sims)
  
  day <- 0
  
  while(sum(completed) < n_sims){
    
    activated <- activation_times < day
    site_stopped <- rep(completed, each=I)
    
    recruitments_day <- activated * (! site_stopped) * rpois(n=I * n_sims, lambda = recruitment_rates)
    recruitments_day_df <- data.frame(matrix(unlist(recruitments_day), ncol=n_sims, byrow=FALSE))
    recruited <- recruited + recruitments_day_df
    recruit_sums <- colSums(recruited)
    completed <- recruit_sums >= N
  
    day <- day + 1  
    
    for(i in 1:n_sims){
      if (completed[i] && ! completed_prev[i]){
        day_completed[i] = day
        completed_prev[i] = TRUE
      }
    }
    
  }
  
  activated_df <- data.frame(matrix(unlist(activated), ncol=n_sims, byrow=FALSE))
  
  sites_activated <- colSums(activated_df)
  
  
  sim_results <- data.frame(matrix(unlist(c(
                                      rep(I,n_sims),
                                      sites_activated,
                                      day_completed,
                                      rep(N,n_sims))), ncol=4, byrow=FALSE))
  colnames(sim_results) <- c("Sites_Initiated","Sites_Activated",
                             "Day_Completed","Required_Recruitment")

  return(sim_results)  
}

```


```{r get simulations at multiple values of activation and delay cost}

results_df <- data.frame()
result_cols <- c("Length_of_Trial_in_Weeks",
                 "Needed_Recruitment",
                 "Activation_Cost_per_Site",
                 "Delay_Cost_per_Week",
                 "Cohort_Size",
                 "Alpha",
                 "Beta",
                 "Mean_Activation_Time_in_Weeks",
                 "Average_Sites_Activated",
                 "Average_Day_Completed",
                 "Site_Activation_Cost",
                 "Average_Delay_Cost",
                 "Average_Total_Cost",
                 "Number_Simulations")

activation_cost_levels <- c(25000, 50000, 75000)
delay_cost_levels <- c(50000 / 7,100000 / 7,150000 / 7)
cohort_size_levels <- c(1:20) * 10

alpha_level <- 10
beta_level <- 4

N_level <- 30000
T_d_level <- 20 * 7

n_sims_level <- 50000

one_site_activation_time = 4*7/5

ptm <- proc.time()

for(cohort_size_level in cohort_size_levels){
      
  mean_activation_time = one_site_activation_time * cohort_size_level
  
  sim_results <- simulate_cost_by_site_activation(N=N_level, I=cohort_size_level,
                                                        lambda_I = 1/mean_activation_time,
                                                        alpha=alpha_level, beta=beta_level,
                                                        n_sims=n_sims_level
                                                        )

  

  for(activation_cost_level in activation_cost_levels){
  
    for(delay_cost_level in delay_cost_levels){
      
      sim_results["Activation_Cost"] <- cohort_size_level * activation_cost_level
      
      sim_results["Delay_Cost"] <- ifelse(sim_results[["Day_Completed"]] > T_d_level,
                                          sim_results[["Day_Completed"]] - T_d_level,
                                          0) * delay_cost_level
      
      sim_results["Total_Cost"] <- sim_results["Activation_Cost"] + sim_results["Delay_Cost"]
      
      sim_means <- colMeans(sim_results)
    
      results_newline <- data.frame(matrix(ncol=length(result_cols),nrow=1))
      colnames(results_newline) <- result_cols
    
      results_newline[["Length_of_Trial_in_Weeks"]] <- T_d_level / 7
      results_newline[["Needed_Recruitment"]] <- N_level
      results_newline[["Activation_Cost_per_Site"]] <- activation_cost_level
      results_newline[["Delay_Cost_per_Week"]] <- delay_cost_level * 7
      results_newline[["Alpha"]] <- alpha_level
      results_newline[["Beta"]] <- beta_level
      results_newline[["Mean_Activation_Time_in_Weeks"]] <- mean_activation_time / 7
      results_newline[["Cohort_Size"]] <- cohort_size_level
      results_newline[["Average_Sites_Activated"]] <- sim_means["Sites_Activated"]
      results_newline[["Average_Day_Completed"]] <- sim_means["Day_Completed"]
      results_newline[["Site_Activation_Cost"]] <- sim_means["Activation_Cost"]
      results_newline[["Average_Delay_Cost"]] <- sim_means["Delay_Cost"]
      results_newline[["Average_Total_Cost"]] <- sim_means["Total_Cost"]
      results_newline[["Number_Simulations"]] <- n_sims_level
    
      
      results_df <- rbind(results_df,results_newline)
      
    }
  }
  
  
  
}

proc.time() - ptm


write.csv(results_df, file = "C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_reruitment_study_11.csv",row.names=FALSE)



```


```{r plot results of delay cost simulation}


results_df_delay <- cbind("Delay",
                          results_df[c("Cohort_Size",
                                       "Activation_Cost_per_Site",
                                       "Delay_Cost_per_Week",
                                       "Average_Delay_Cost")])
colnames(results_df_delay) <- c("Cost_Type",
                                "Cohort_Size",
                                "Activation_Cost_per_Site",
                                "Delay_Cost_per_Week",
                                "Average_Cost")


results_df_activation <- cbind("Activation",
                          results_df[c("Cohort_Size",
                                       "Activation_Cost_per_Site",
                                       "Delay_Cost_per_Week",
                                       "Site_Activation_Cost")])
colnames(results_df_activation) <- c("Cost_Type",
                                "Cohort_Size",
                                "Activation_Cost_per_Site",
                                "Delay_Cost_per_Week",
                                "Average_Cost")

results_df_total <- cbind("Total",
                          results_df[c("Cohort_Size",
                                       "Activation_Cost_per_Site",
                                       "Delay_Cost_per_Week",
                                       "Average_Total_Cost")])
colnames(results_df_total) <- c("Cost_Type",
                                "Cohort_Size",
                                "Activation_Cost_per_Site",
                                "Delay_Cost_per_Week",
                                "Average_Cost")

results_df_cost_type <- rbind(results_df_delay,
                              results_df_activation,
                              results_df_total)

activation_cost_labels <- paste(dollar_format()(activation_cost_levels),"per Site")
names(activation_cost_labels) <- activation_cost_levels

delay_cost_labels <- paste(dollar_format()(delay_cost_levels * 7),"per Week")
names(delay_cost_labels) <- delay_cost_levels * 7

ggplot() +
  geom_line(data=results_df_cost_type, aes(x=Cohort_Size,y=Average_Cost, group=Cost_Type, color=Cost_Type)) +
  facet_grid(Activation_Cost_per_Site ~ Delay_Cost_per_Week,
             labeller=labeller(Activation_Cost_per_Site=activation_cost_labels,
                               Delay_Cost_per_Week=delay_cost_labels)) +
  xlab("Initiated Sites") +
  ylab("Average Cost") +
  scale_y_continuous(labels=scales::dollar_format())

ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_11_a.png")
  
```


```{r plot delay}

results_df_1_param <- results_df[which(results_df["Activation_Cost_per_Site"] == activation_cost_levels[1]
                                 & results_df["Delay_Cost_per_Week"] == delay_cost_levels[1]*7),]

ggplot() +
  geom_line(data=results_df_1_param, aes(x=Cohort_Size,y=Average_Day_Completed)) +
  xlab("Initiated Sites") +
  ylab("Days to Completion") + 
  ggtitle("Days to Complete Trial")

ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_11_b.png")

```


```{r plot site activation}

ggplot() +
  geom_line(data=results_df_1_param, aes(x=Cohort_Size,y=Average_Sites_Activated)) +
  xlab("Initiated Sites") +
  ylab("Activated Sites") + 
  ggtitle("Sites Activated Before Trial Completion")

ggsave("C:/Users/mclef/Documents/Research/Clinical Trials/sim results/Cohort Recruitment Distribution/Exponential Establishment/cohort_recruitment_study_11_c.png")

```
